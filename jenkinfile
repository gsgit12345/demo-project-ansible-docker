pipeline{

    agent any
    tools {
      maven 'MAVEN_HOME'
        }
environment {
  DOCKER_TAG = getCommitVersionInshort()
}

   stages{

        stage("clone the project")
        {
            steps
            {
               git branch: 'release/0.1', url: 'https://github.com/gsgit12345/demo-project-ansible-docker'
            }
        }
        stage("build the project")
        {
            steps
            {
               sh  "echo building the project"
               sh "mvn clean package"
            }
        }
        stage("build the docker image")
        {
            steps
            {
               sh  "echo building the docker image"
               sh "docker build . -t gshukla123/docker-ansible-img:${DOCKER_TAG}"
            }
        }
    stage("push the docker image")
        {
            steps
            {
               sh  " echo pushing the   the docker image"
               withCredentials([string(credentialsId: 'docker-pass', variable: 'dockerhubpwd')]) {
                sh "docker login -u gshukla123 -p ${dockerhubpwd}"

                }
               sh "docker push  gshukla123/docker-ansible-img:${DOCKER_TAG}"
            }
        }
        stage("deploy the docker image")
        {
            steps
            {
               sh  " echo deploying the   the docker image"
              ansiblePlaybook credentialsId: 'centos9cre', disableHostKeyChecking: true, extras: "-e DOCKER_TAG=${DOCKER_TAG}", installation: 'ansiblepath', inventory: 'dev.inv', playbook: 'docker-deploy-ansible.yaml', vaultTmpPath: ''
            }
        }


    }

}

def getCommitVersionInshort(){
   def commitid= sh returnStdout: true, script: 'git rev-parse --short HEAD'
   return commitid
}